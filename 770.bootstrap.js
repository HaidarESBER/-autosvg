"use strict";(self.webpackChunkhaidar_app=self.webpackChunkhaidar_app||[]).push([[770],{659(e,t,n){e.exports=n.p+"e57b324656398b8a270c.wasm"},770(e,t,n){let o;function r(e){const t=o.__externref_table_alloc();return o.__wbindgen_externrefs.set(t,e),t}function i(e){const t=typeof e;if("number"==t||"boolean"==t||null==e)return`${e}`;if("string"==t)return`"${e}"`;if("symbol"==t){const t=e.description;return null==t?"Symbol":`Symbol(${t})`}if("function"==t){const t=e.name;return"string"==typeof t&&t.length>0?`Function(${t})`:"Function"}if(Array.isArray(e)){const t=e.length;let n="[";t>0&&(n+=i(e[0]));for(let o=1;o<t;o++)n+=", "+i(e[o]);return n+="]",n}const n=/\[object ([^\]]+)\]/.exec(toString.call(e));let o;if(!(n&&n.length>1))return toString.call(e);if(o=n[1],"Object"==o)try{return"Object("+JSON.stringify(e)+")"}catch(e){return"Object"}return e instanceof Error?`${e.name}: ${e.message}\n${e.stack}`:o}let a=null;function s(){return(null===a||!0===a.buffer.detached||void 0===a.buffer.detached&&a.buffer!==o.memory.buffer)&&(a=new DataView(o.memory.buffer)),a}function l(e,t){return function(e,t){return h+=t,h>=p&&(f=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),f.decode(),h=t),f.decode(d().subarray(e,e+t))}(e>>>=0,t)}let c=null;function d(){return null!==c&&0!==c.byteLength||(c=new Uint8Array(o.memory.buffer)),c}function g(e,t){try{return e.apply(this,t)}catch(e){const t=r(e);o.__wbindgen_exn_store(t)}}function u(e){return null==e}function m(e,t,n){if(void 0===n){const n=b.encode(e),o=t(n.length,1)>>>0;return d().subarray(o,o+n.length).set(n),w=n.length,o}let o=e.length,r=t(o,1)>>>0;const i=d();let a=0;for(;a<o;a++){const t=e.charCodeAt(a);if(t>127)break;i[r+a]=t}if(a!==o){0!==a&&(e=e.slice(a)),r=n(r,o,o=a+3*e.length,1)>>>0;const t=d().subarray(r+a,r+o);a+=b.encodeInto(e,t).written,r=n(r,o,a,1)>>>0}return w=a,r}let f=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});f.decode();const p=2146435072;let h=0;const b=new TextEncoder;"encodeInto"in b||(b.encodeInto=function(e,t){const n=b.encode(e);return t.set(n),{read:e.length,written:n.length}});let w=0;const y="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>o.__wbg_binaryimageconverter_free(e>>>0,1)),v="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>o.__wbg_colorimageconverter_free(e>>>0,1));class _{static __wrap(e){e>>>=0;const t=Object.create(_.prototype);return t.__wbg_ptr=e,y.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,y.unregister(this),e}free(){const e=this.__destroy_into_raw();o.__wbg_binaryimageconverter_free(e,0)}static new_with_string(e){const t=m(e,o.__wbindgen_malloc,o.__wbindgen_realloc),n=w,r=o.binaryimageconverter_new_with_string(t,n);return _.__wrap(r)}init(){o.binaryimageconverter_init(this.__wbg_ptr)}tick(){return 0!==o.binaryimageconverter_tick(this.__wbg_ptr)}progress(){return o.binaryimageconverter_progress(this.__wbg_ptr)>>>0}}Symbol.dispose&&(_.prototype[Symbol.dispose]=_.prototype.free);class E{static __wrap(e){e>>>=0;const t=Object.create(E.prototype);return t.__wbg_ptr=e,v.register(t,t.__wbg_ptr,t),t}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,v.unregister(this),e}free(){const e=this.__destroy_into_raw();o.__wbg_colorimageconverter_free(e,0)}static new_with_string(e){const t=m(e,o.__wbindgen_malloc,o.__wbindgen_realloc),n=w,r=o.colorimageconverter_new_with_string(t,n);return E.__wrap(r)}init(){o.colorimageconverter_init(this.__wbg_ptr)}tick(){return 0!==o.colorimageconverter_tick(this.__wbg_ptr)}progress(){return o.colorimageconverter_progress(this.__wbg_ptr)}}Symbol.dispose&&(E.prototype[Symbol.dispose]=E.prototype.free);const k=new Set(["basic","cors","default"]);function I(){const e={wbg:{}};return e.wbg.__wbg___wbindgen_debug_string_adfb662ae34724b6=function(e,t){const n=m(i(t),o.__wbindgen_malloc,o.__wbindgen_realloc),r=w;s().setInt32(e+4,r,!0),s().setInt32(e+0,n,!0)},e.wbg.__wbg___wbindgen_is_undefined_f6b95eab589e0269=function(e){return void 0===e},e.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(e,t){throw new Error(l(e,t))},e.wbg.__wbg_call_abb4ff46ce38be40=function(){return g(function(e,t){return e.call(t)},arguments)},e.wbg.__wbg_createElementNS_e7c12bbd579529e2=function(){return g(function(e,t,n,o,r){return e.createElementNS(0===t?void 0:l(t,n),l(o,r))},arguments)},e.wbg.__wbg_data_83b2a9a09dd4ab39=function(e,t){const n=function(e,t){const n=t(1*e.length,1)>>>0;return d().set(e,n/1),w=e.length,n}(t.data,o.__wbindgen_malloc),r=w;s().setInt32(e+4,r,!0),s().setInt32(e+0,n,!0)},e.wbg.__wbg_debug_9ad80675faf0c9cf=function(e,t,n,o){console.debug(e,t,n,o)},e.wbg.__wbg_document_5b745e82ba551ca5=function(e){const t=e.document;return u(t)?0:r(t)},e.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let n,r;try{n=e,r=t,console.error(l(e,t))}finally{o.__wbindgen_free(n,r,1)}},e.wbg.__wbg_error_ad1ecdacd1bb600d=function(e,t,n,o){console.error(e,t,n,o)},e.wbg.__wbg_getContext_01f42b234e833f0a=function(){return g(function(e,t,n){const o=e.getContext(l(t,n));return u(o)?0:r(o)},arguments)},e.wbg.__wbg_getElementById_e05488d2143c2b21=function(e,t,n){const o=e.getElementById(l(t,n));return u(o)?0:r(o)},e.wbg.__wbg_getImageData_fbd5fac79d0f455a=function(){return g(function(e,t,n,o,r){return e.getImageData(t,n,o,r)},arguments)},e.wbg.__wbg_height_a07787f693c253d2=function(e){return e.height},e.wbg.__wbg_info_b7fa8ce2e59d29c6=function(e,t,n,o){console.info(e,t,n,o)},e.wbg.__wbg_instanceof_CanvasRenderingContext2d_d070139aaac1459f=function(e){let t;try{t=e instanceof CanvasRenderingContext2D}catch(e){t=!1}return t},e.wbg.__wbg_instanceof_HtmlCanvasElement_c4251b1b6a15edcc=function(e){let t;try{t=e instanceof HTMLCanvasElement}catch(e){t=!1}return t},e.wbg.__wbg_instanceof_Window_b5cf7783caa68180=function(e){let t;try{t=e instanceof Window}catch(e){t=!1}return t},e.wbg.__wbg_log_f614673762e98966=function(e,t,n,o){console.log(e,t,n,o)},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_new_no_args_cb138f77cf6151ee=function(e,t){return new Function(l(e,t))},e.wbg.__wbg_prepend_ab79c004564b1208=function(){return g(function(e,t){e.prepend(t)},arguments)},e.wbg.__wbg_setAttribute_34747dd193f45828=function(){return g(function(e,t,n,o,r){e.setAttribute(l(t,n),l(o,r))},arguments)},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const n=m(t.stack,o.__wbindgen_malloc,o.__wbindgen_realloc),r=w;s().setInt32(e+4,r,!0),s().setInt32(e+0,n,!0)},e.wbg.__wbg_static_accessor_GLOBAL_769e6b65d6557335=function(){const e=void 0===n.g?null:n.g;return u(e)?0:r(e)},e.wbg.__wbg_static_accessor_GLOBAL_THIS_60cf02db4de8e1c1=function(){const e="undefined"==typeof globalThis?null:globalThis;return u(e)?0:r(e)},e.wbg.__wbg_static_accessor_SELF_08f5a74c69739274=function(){const e="undefined"==typeof self?null:self;return u(e)?0:r(e)},e.wbg.__wbg_static_accessor_WINDOW_a8924b26aa92d024=function(){const e="undefined"==typeof window?null:window;return u(e)?0:r(e)},e.wbg.__wbg_warn_165ef4f6bcfc05e7=function(e,t,n,o){console.warn(e,t,n,o)},e.wbg.__wbg_width_dd0cfe94d42f5143=function(e){return e.width},e.wbg.__wbindgen_cast_2241b6af4c4b2941=function(e,t){return l(e,t)},e.wbg.__wbindgen_init_externref_table=function(){const e=o.__wbindgen_externrefs,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},e}async function L(e){if(void 0!==o)return o;void 0!==e&&(Object.getPrototypeOf(e)===Object.prototype?({module_or_path:e}=e):console.warn("using deprecated parameters for the initialization function; pass a single object instead")),void 0===e&&(e=new URL(n(659),n.b));const t=I();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:r,module:i}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if(!e.ok||!k.has(e.type)||"application/wasm"===e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}(await e,t);return function(e,t){return o=e.exports,L.__wbindgen_wasm_module=t,a=null,c=null,o.__wbindgen_start(),o}(r,i)}const B=L;var A=n(848),R=n(710),C=n.n(R);let x;const S=document.getElementById("frame"),F=S.getContext("2d",{willReadFrequently:!0}),U=document.getElementById("svg"),D=new Image,M=document.getElementById("progressbar"),P=document.getElementById("progressregion");let T="spline",O="color",N="stacked",z=!1,j=!1;window.bgRemoved=!1;const H=document.getElementById("preview-container"),$=document.getElementById("droptext"),q=document.getElementById("convert-btn"),W=document.getElementById("export"),V=document.getElementById("export-png"),G=document.getElementById("download-nobg"),X=document.getElementById("retouch-btn"),Z=document.getElementById("retouch-controls"),J=document.getElementById("brush-size"),Y=document.getElementById("brush-size-value"),K=document.getElementById("retouch-remove"),Q=document.getElementById("retouch-restore"),ee=document.getElementById("retouch-done");console.log("Retouch elements:",{retouchBtn:!!X,retouchControls:!!Z,downloadNoBgBtn:!!G,retouchRemoveBtn:!!K,retouchRestoreBtn:!!Q,retouchDoneBtn:!!ee});let te=!1,ne=null,oe=!1,re=!1,ie=20;q.disabled=!0;const ae=document.getElementById("remove-bg-btn"),se=document.getElementById("settings-btn"),le=document.getElementById("settings-panel");ae.disabled=!0;let ce=!1;se&&le&&se.addEventListener("click",function(){ce=!ce,le.style.display=ce?"block":"none";const e=se.querySelector("span:last-child")||se;"SPAN"===e.tagName?e.textContent=ce?"Hide Settings":"Vectorization Settings":se.innerHTML=ce?"<span>‚öôÔ∏è</span><span>Hide Settings</span>":"<span>‚öôÔ∏è</span><span>Vectorization Settings</span>"}),ae.addEventListener("click",function(){te&&D.src?async function(){ae.disabled=!0;const e=ae.querySelector("span:last-child")||ae;"SPAN"===e.tagName?e.textContent="Processing...":ae.innerHTML="<span>‚è≥</span><span>Processing...</span>";try{const t=S.width,n=S.height,o=await new Promise(e=>S.toBlob(e,"image/png",.95));"SPAN"===e.tagName?e.textContent="Removing background (rembg model)...":ae.innerHTML="<span>‚è≥</span><span>Removing background (rembg model)...</span>",console.log("Processing with @imgly/background-removal (U2-Net - same as rembg Python)...");const r=await(0,A.hS)(o,{model:"isnet_fp16",output:{format:"image/png"}});"SPAN"===e.tagName?e.textContent="Applying result...":ae.innerHTML="<span>‚è≥</span><span>Applying result...</span>";const i=new Image;i.onload=()=>{F.clearRect(0,0,S.width,S.height),F.imageSmoothingEnabled=!0,F.imageSmoothingQuality="high",F.drawImage(i,0,0,t,n);const e=F.getImageData(0,0,S.width,S.height).data,o=S.width,r=S.height,a=new Uint8ClampedArray(e);for(let t=2;t<r-2;t++)for(let n=2;n<o-2;n++){const r=4*(t*o+n),i=e[r+3];if(i>128){let s=i;for(let r=-2;r<=2;r++)for(let i=-2;i<=2;i++){if(0===i&&0===r)continue;const a=e[4*((t+r)*o+(n+i))+3];a>s&&(s=a)}s>i&&i>50&&(a[r+3]=Math.min(255,i+.3*(s-i)))}}for(let e=1;e<r-1;e++)for(let t=1;t<o-1;t++){const n=4*(e*o+t),r=a[n+3];if(r>20&&r<235){const i=a[4*((e-1)*o+t)+3],s=a[4*((e+1)*o+t)+3],l=a[4*(e*o+(t-1))+3],c=a[4*(e*o+(t+1))+3],d=Math.round((3*r+i+s+l+c)/7);a[n+3]=d}}for(let e=0;e<a.length;e+=4){const t=a[e+3];t>30&&t<200&&a[e]+a[e+1]+a[e+2]>50&&(a[e+3]=Math.min(255,1.15*t))}F.putImageData(new ImageData(a,o,r),0,0),ne=F.getImageData(0,0,S.width,S.height),j=!0,window.bgRemoved=!0,window.skipBgReset=!0,D.src=S.toDataURL(),console.log("üîµ bgRemoved set to TRUE:",j),console.log("üîµ window.bgRemoved set to TRUE:",window.bgRemoved),console.log("üîµ originalImageData exists:",!!ne),setTimeout(()=>{window.skipBgReset=!1,console.log("üîµ skipBgReset cleared, bgRemoved should still be:",j,"window.bgRemoved:",window.bgRemoved)},2e3),Ee=2,ke=7,Ie=12,ye=60,ve=4,_e=45,document.getElementById("filterspeckle").value=Ee,document.getElementById("filterspecklevalue").innerHTML=Ee,document.getElementById("colorprecision").value=ke,document.getElementById("colorprecisionvalue").innerHTML=ke,document.getElementById("layerdifference").value=Ie,document.getElementById("layerdifferencevalue").innerHTML=Ie,document.getElementById("corner").value=ye,document.getElementById("cornervalue").innerHTML=ye,document.getElementById("length").value=ve,document.getElementById("lengthvalue").innerHTML=ve,document.getElementById("splice").value=_e,document.getElementById("splicevalue").innerHTML=_e,console.log("Applied default no-background settings");const s=document.getElementById("after-bg-removed");s&&(s.style.display="block",s.style.visibility="visible",s.style.opacity="1"),G&&(G.style.opacity="1",G.style.pointerEvents="auto");const l=document.getElementById("retouch-btn");l?(l.disabled=!1,l.removeAttribute("disabled"),l.style.opacity="1",l.style.pointerEvents="auto",l.style.cursor="pointer",l.style.visibility="visible",l.style.display="block",l.style.position="relative",l.style.zIndex="1000",l.style.userSelect="auto",l.style.touchAction="auto",ge(),setTimeout(()=>{const e=l.getBoundingClientRect(),t=window.getComputedStyle(l);console.log("‚úÖ Retouch button enabled:",{disabled:l.disabled,opacity:t.opacity,pointerEvents:t.pointerEvents,cursor:t.cursor,display:t.display,visibility:t.visibility,zIndex:t.zIndex,position:t.position,width:e.width,height:e.height,top:e.top,left:e.left});const n=document.elementFromPoint(e.left+e.width/2,e.top+e.height/2);console.log("Element at button center:",n?.id||n?.tagName),n===l||l.contains(n)||console.warn("‚ö†Ô∏è Button might be blocked by:",n)},100)):console.error("‚ùå retouchBtn is null!"),ae.textContent="‚úÖ Background Removed",ae.style.background="#28a745 !important",ae.disabled=!1,console.log("‚úÖ Background removal completed with edge refinement"),console.log("‚úÖ bgRemoved status:",j),console.log("‚úÖ originalImageData status:",!!ne),console.log("Retouch buttons should now be visible and clickable")},i.onerror=e=>{throw new Error("Failed to load processed image: "+e)},i.src=URL.createObjectURL(r)}catch(e){console.error("Error removing background with rembg:",e);const t=ae.querySelector("span:last-child")||ae;"SPAN"===t.tagName?t.textContent="Remove Background":ae.innerHTML="<span>üé®</span><span>Remove Background</span>",ae.disabled=!1,e.message.includes("fetch")||e.message.includes("network")||e.message.includes("model")?alert("‚ö†Ô∏è Error: Could not load AI model.\n\nThe U2-Net model needs to be downloaded on first use (~10-20MB).\n\nPlease check your internet connection and try again.\n\nAfter first download, it will be cached for offline use."):alert("Error removing background: "+e.message)}}():alert("Please load an image first.")});let de=!1;function ge(){const e=document.getElementById("retouch-btn");if(!e)return void console.error("‚ùå retouchBtn not found when trying to attach event listener!");console.log("Attaching retouch button event listener to:",e);const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e);const n=document.getElementById("retouch-btn");n.addEventListener("click",window.handleRetouchClick,!0),n.addEventListener("mousedown",function(e){console.log("üîµ Retouch button mousedown event"),e.preventDefault(),window.handleRetouchClick(e)},!0)}window.handleRetouchClick=function(e){if(e&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()),de)return console.log("‚è∏Ô∏è Retouch click locked, ignoring"),!1;const t=document.getElementById("retouch-btn");if(!t)return console.error("‚ùå retouchBtn not found!"),!1;if(!(void 0!==window.bgRemoved?window.bgRemoved:j)&&!j)return console.error("‚ùå bgRemoved is FALSE! Cannot proceed."),alert("Please remove background first."),!1;if(!ne)return alert("Error: Original image data not available. Please remove background again."),!1;if(de=!0,setTimeout(()=>{de=!1},300),re=!re,re){Z&&(Z.style.display="block",Z.style.visibility="visible",Z.style.opacity="1");const e=t.querySelector("span:last-child")||t;"SPAN"===e.tagName?e.textContent="Stop Retouching":t.innerHTML="<span>‚è∏Ô∏è</span><span>Stop Retouching</span>",t.className="btn btn-danger",S.style.cursor="crosshair",S.style.userSelect="none",oe||(oe="remove"),K&&K.classList.add("active"),Q&&Q.classList.remove("active"),console.log("‚úÖ Retouching mode ACTIVATED, mode:",oe)}else{Z&&(Z.style.display="none");const e=t.querySelector("span:last-child")||t;"SPAN"===e.tagName?e.textContent="Start Retouching":t.innerHTML="<span>‚úèÔ∏è</span><span>Start Retouching</span>",t.className="btn btn-warning",S.style.cursor="default",S.style.userSelect="auto",ue=!1,window.skipBgReset=!0,D.src=S.toDataURL(),setTimeout(()=>{window.skipBgReset=!1},500),console.log("‚è∏Ô∏è Retouching mode DEACTIVATED")}return!1},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",ge):ge(),J&&J.addEventListener("input",function(){ie=parseInt(this.value),Y&&(Y.textContent=ie),console.log("Brush size changed to:",ie)}),K&&K.addEventListener("click",function(e){if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!re){re=!0,Z&&(Z.style.display="block");const e=document.getElementById("retouch-btn");if(e){const t=e.querySelector("span:last-child")||e;"SPAN"===t.tagName?t.textContent="Stop Retouching":e.innerHTML="<span>‚è∏Ô∏è</span><span>Stop Retouching</span>",e.className="btn btn-danger"}S.style.cursor="crosshair"}oe="remove",K.classList.add("active"),Q&&Q.classList.remove("active"),console.log("‚úÖ Retouch mode set to: remove")}),Q&&Q.addEventListener("click",function(e){if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!re){re=!0,Z&&(Z.style.display="block");const e=document.getElementById("retouch-btn");if(e){const t=e.querySelector("span:last-child")||e;"SPAN"===t.tagName?t.textContent="Stop Retouching":e.innerHTML="<span>‚è∏Ô∏è</span><span>Stop Retouching</span>",e.className="btn btn-danger"}S.style.cursor="crosshair"}oe="restore",Q.classList.add("active"),K&&K.classList.remove("active"),console.log("‚úÖ Retouch mode set to: restore")}),ee&&ee.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),re=!1,ue=!1,Z&&(Z.style.display="none");const t=document.getElementById("retouch-btn");if(t){const e=t.querySelector("span:last-child")||t;"SPAN"===e.tagName?e.textContent="Start Retouching":t.innerHTML="<span>‚úèÔ∏è</span><span>Start Retouching</span>",t.className="btn btn-warning"}S.style.cursor="default",S.style.userSelect="auto",window.skipBgReset=!0,D.src=S.toDataURL(),setTimeout(()=>{window.skipBgReset=!1},500),console.log("‚úÖ Retouching done and saved")});let ue=!1,me=0,fe=0;function pe(e,t){if(!re)return;if(!ne)return void console.warn("No original image data for retouching");oe||(oe="remove");const n=F.getImageData(0,0,S.width,S.height),o=n.data,r=ne.data,i=ie,a=S.width/S.getBoundingClientRect().width,s=S.height/S.getBoundingClientRect().height,l=Math.round(e*a),c=Math.round(t*s);for(let e=-i;e<=i;e++)for(let t=-i;t<=i;t++){const n=Math.sqrt(t*t+e*e);if(n>i)continue;const a=l+t,s=c+e;if(a<0||a>=S.width||s<0||s>=S.height)continue;const d=4*(s*S.width+a),g=n/i,u=1-g*g;if("remove"===oe){const e=o[d+3],t=.9*u;o[d+3]=Math.max(0,Math.round(e*(1-t)))}else if("restore"===oe){const e=o[d+3],t=r[d+3];o[d+3]=Math.min(255,Math.round(t*u+e*(1-u))),o[d]=Math.round(r[d]*u+o[d]*(1-u)),o[d+1]=Math.round(r[d+1]*u+o[d+1]*(1-u)),o[d+2]=Math.round(r[d+2]*u+o[d+2]*(1-u))}}F.putImageData(n,0,0)}S.addEventListener("mousedown",function(e){if(!re)return;oe||(oe="remove",K&&K.classList.add("active"),Q&&Q.classList.remove("active")),e.preventDefault(),e.stopPropagation(),ue=!0;const t=S.getBoundingClientRect();me=e.clientX-t.left,fe=e.clientY-t.top,pe(me,fe)}),S.addEventListener("mousemove",function(e){if(!re||!ue)return;e.preventDefault(),e.stopPropagation();const t=S.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top;!function(e,t,n,o){const r=Math.max(Math.abs(n-e),Math.abs(o-t));for(let i=0;i<=r;i++){const a=i/r;pe(e+(n-e)*a,t+(o-t)*a)}}(me,fe,n,o),me=n,fe=o}),S.addEventListener("mouseup",function(e){re&&(e.preventDefault(),e.stopPropagation()),ue=!1}),S.addEventListener("mouseleave",function(e){re&&e.preventDefault(),ue=!1}),S.addEventListener("contextmenu",function(e){if(re)return e.preventDefault(),!1}),G.addEventListener("click",function(e){e.preventDefault(),j?S.toBlob(function(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="haidar-app-no-bg-"+(new Date).toISOString().slice(0,19).replace(/:/g,"").replace("T"," ")+".png",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)},"image/png"):alert("Please remove background first.")}),console.log("Initializing WASM module..."),B("./pkg/haidar_app_bg.wasm").then(()=>{console.log("WASM module initialized successfully!"),z=!0,te&&(q.disabled=!1,ae.disabled=!1)}).catch(e=>{console.error("Failed to initialize WASM module:",e),alert("Failed to initialize the application. Please refresh the page.")}),document.addEventListener("paste",function(e){if(e.clipboardData){var t=e.clipboardData.items;if(!t)return;for(var n=0;n<t.length;n++)if(-1!==t[n].type.indexOf("image")){var o=t[n].getAsFile();Ae((window.URL||window.webkitURL).createObjectURL(o))}e.preventDefault()}}),q.addEventListener("click",function(e){console.log("Convert button clicked",{imageLoaded:te,hasImgSrc:!!D.src,wasmInitialized:z}),z?te&&D.src?(console.log("Starting conversion..."),Re()):(console.warn("Cannot convert: image not loaded",{imageLoaded:te,hasImgSrc:!!D.src}),alert("Please load an image first by dragging and dropping or selecting a file.")):alert("WASM module is still initializing. Please wait a moment and try again.")}),document.getElementById("export").addEventListener("click",function(e){const t=new Blob(['<?xml version="1.0" encoding="UTF-8"?>\n',"\x3c!-- Generator: HaidarApp --\x3e\n",(new XMLSerializer).serializeToString(U)],{type:"octet/stream"}),n=window.URL.createObjectURL(t);this.href=n,this.target="_blank",this.download="haidar-app-export-"+(new Date).toISOString().slice(0,19).replace(/:/g,"").replace("T"," ")+".svg"}),document.getElementById("export-png").addEventListener("click",function(e){e.preventDefault();const t=U.getBoundingClientRect(),n=parseInt(U.getAttribute("width"))||t.width,o=parseInt(U.getAttribute("height"))||t.height,r=document.createElement("canvas");r.width=n,r.height=o;const i=r.getContext("2d"),a=(new XMLSerializer).serializeToString(U),s=new Blob([a],{type:"image/svg+xml;charset=utf-8"}),l=URL.createObjectURL(s),c=new Image;c.onload=function(){i.drawImage(c,0,0,n,o),r.toBlob(function(e){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="haidar-app-export-"+(new Date).toISOString().slice(0,19).replace(/:/g,"").replace("T"," ")+".png",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),URL.revokeObjectURL(l)},"image/png")},c.onerror=function(){alert("Error converting SVG to PNG. Please try again."),URL.revokeObjectURL(l)},c.src=l});var he=document.getElementById("imageSelect"),be=document.getElementById("imageInput");he.addEventListener("click",function(e){be.click(),e.preventDefault()}),be.addEventListener("change",function(e){Ae(this.files[0])});var we=document.getElementById("drop");we.addEventListener("dragenter",function(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy",$.classList.add("hovering"),!1}),we.addEventListener("dragleave",function(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy",$.classList.remove("hovering"),!1}),we.addEventListener("dragover",function(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="copy",$.classList.add("hovering"),!1}),we.addEventListener("drop",function(e){return e.preventDefault&&e.preventDefault(),$.classList.remove("hovering"),Ae(e.dataTransfer.files[0]),!1});var ye=parseInt(document.getElementById("corner").value),ve=parseFloat(document.getElementById("length").value),_e=parseInt(document.getElementById("splice").value),Ee=parseInt(document.getElementById("filterspeckle").value),ke=parseInt(document.getElementById("colorprecision").value),Ie=parseInt(document.getElementById("layerdifference").value),Le=parseInt(document.getElementById("pathprecision").value);function Be(e,t){document.getElementById(e).classList.add("selected"),t.forEach(e=>{document.getElementById(e).classList.remove("selected")})}function Ae(e){window.skipBgReset?console.log("Skipping setSourceAndRestart because skipBgReset is true"):(D.src=e instanceof File?URL.createObjectURL(e):e,D.onload=function(){if(window.skipBgReset)return void console.log("Skipping img.onload reset because skipBgReset is true");const e=D.naturalWidth,t=D.naturalHeight;for(U.setAttribute("viewBox",`0 0 ${e} ${t}`),U.setAttribute("width",e),U.setAttribute("height",t),U.setAttribute("style","background: transparent;"),U.style.background="transparent",S.width=D.naturalWidth,S.height=D.naturalHeight;U.firstChild;)U.removeChild(U.firstChild);F.clearRect(0,0,S.width,S.height),F.drawImage(D,0,0,S.width,S.height),$.style.display="none",H.style.display="grid",H.classList.add("active"),te=!0,z&&(q.disabled=!1,q.textContent="üîÑ Convert to SVG",ae.disabled=!1),W.style.opacity="0.5",W.style.pointerEvents="none",V.style.opacity="0.5",V.style.pointerEvents="none",G&&(G.style.opacity="0.5",G.style.pointerEvents="none"),X&&(X.disabled=!0,X.setAttribute("disabled","disabled"),X.style.opacity="0.5",X.style.pointerEvents="none",X.style.cursor="not-allowed"),Z.style.display="none",window.skipBgReset?console.log("Preserving state during img.onload - isRetouching:",re,"bgRemoved:",j):(j=!1,window.bgRemoved=!1,ne=null,re=!1),ae.textContent="üé® Remove Background",ae.style.background="#28a745 !important",S.style.cursor="default",console.log("Image loaded and preview shown. Buttons enabled:",z)})}function Re(){if(document.getElementById("clustering-binary").classList.remove("selected"),document.getElementById("clustering-color").classList.remove("selected"),document.getElementById("clustering-"+O).classList.add("selected"),Array.from(document.getElementsByClassName("clustering-color-options")).forEach(e=>{e.style.display="color"==O?"":"none"}),document.getElementById("clustering-cutout").classList.remove("selected"),document.getElementById("clustering-stacked").classList.remove("selected"),document.getElementById("clustering-"+N).classList.add("selected"),document.getElementById("none").classList.remove("selected"),document.getElementById("polygon").classList.remove("selected"),document.getElementById("spline").classList.remove("selected"),document.getElementById(T).classList.add("selected"),Array.from(document.getElementsByClassName("spline-options")).forEach(e=>{e.style.display="spline"==T?"":"none"}),!D.src||!te)return;for(q.disabled=!0,q.textContent="‚è≥ Converting...";U.firstChild;)U.removeChild(U.firstChild);if(j?console.log("Using current canvas content (includes retouching if applicable)"):(F.clearRect(0,0,S.width,S.height),F.drawImage(D,0,0),console.log("Using original image (no background removal yet)")),j){const e=F.getImageData(0,0,S.width,S.height),t=e.data;for(let e=0;e<t.length;e+=4)t[e+3]<10&&(t[e+3]=0);F.putImageData(e,0,0)}let e=JSON.stringify({canvas_id:S.id,svg_id:U.id,mode:T,clustering_mode:O,hierarchical:N,corner_threshold:Ce(ye),length_threshold:ve,max_iterations:10,splice_threshold:Ce(_e),filter_speckle:Ee*Ee,color_precision:8-ke,layer_difference:Ie,path_precision:Le});if(x&&!x.stopped)try{x.stop()}catch(e){console.warn("Error stopping previous runner:",e)}console.log("Creating converter runner with params:",e),x=new xe(e),M.value=0,P.style.display="block",console.log("Starting conversion, progress bar shown"),x.run().then(()=>{console.log("Conversion complete!"),q.textContent="üîÑ Convert to SVG",q.disabled=!1,void 0!==window.currentBulkEditIndex&&function(){if(void 0===window.currentBulkEditIndex)return;const e=window.currentBulkEditIndex,t=Fe[e];t&&S.toBlob(function(e){if(t.noBgImage=e,U.children.length>0){const e=U.cloneNode(!0);e.querySelectorAll("rect").forEach(t=>{const n=t.getAttribute("width"),o=t.getAttribute("height"),r=e.getAttribute("width"),i=e.getAttribute("height");"100%"!==n&&n!==r||"100%"!==o&&o!==i||t.remove()});let n=(new XMLSerializer).serializeToString(e);try{const e=(new DOMParser).parseFromString(n,"image/svg+xml").documentElement;e.querySelectorAll("rect").forEach(t=>{const n=t.getAttribute("width")||"",o=t.getAttribute("height")||"",r=t.getAttribute("x")||"0",i=t.getAttribute("y")||"0",a=t.getAttribute("fill")||"",s=t.getAttribute("style")||"",l=e.getAttribute("width")||"",c=e.getAttribute("height")||"",d="100%"===n||n===l||parseFloat(n)>=.9*parseFloat(l||0),g="100%"===o||o===c||parseFloat(o)>=.9*parseFloat(c||0),u=!("0"!==r&&r||"0"!==i&&i),m=a.toLowerCase(),f=s.toLowerCase(),p=m.includes("red")||"#ff0000"===m||m.startsWith("#ff")&&m.length<=7||m.includes("rgb(255")||f.includes("fill:")&&(f.includes("red")||f.includes("#ff"));(d&&g&&u||p)&&t.remove()}),e.removeAttribute("fill"),e.removeAttribute("background"),e.removeAttribute("background-color"),e.setAttribute("style","background: transparent !important;"),e.querySelectorAll("*").forEach(e=>{const t=e.getAttribute("fill")||"",n=e.getAttribute("style")||"",o=t.toLowerCase(),r=n.toLowerCase();if(o.includes("red")||"#ff0000"===o||o.startsWith("#ff")&&o.length<=7||r.includes("fill:")&&(r.includes("red")||r.includes("#ff")))if("rect"===e.tagName)e.remove();else if(e.removeAttribute("fill"),n){const t=n.replace(/fill\s*:\s*[^;]+/gi,"").replace(/background[^;]*/gi,"").trim();t?e.setAttribute("style",t):e.removeAttribute("style")}}),n=(new XMLSerializer).serializeToString(e)}catch(e){console.warn("Error in final SVG cleanup (updateBulkResultAfterEdit):",e),n=n.replace(/fill\s*=\s*["']?#?ff[0-9a-fA-F]*["']?/gi,""),n=n.replace(/fill\s*:\s*#?ff[0-9a-fA-F]*/gi,""),n=n.replace(/fill\s*=\s*["']?red["']?/gi,"")}(n.includes('fill="#ff')||n.includes('fill="#FF')||n.includes('fill="red')||n.includes('fill="Red')||n.includes("fill:#ff")||n.includes("fill:red")||n.includes("background")&&(n.includes("red")||n.includes("#ff")))&&(n=n.replace(/fill\s*=\s*["']?#?ff[0-9a-fA-F]{0,6}["']?/gi,""),n=n.replace(/fill\s*:\s*#?ff[0-9a-fA-F]{0,6}/gi,""),n=n.replace(/fill\s*=\s*["']?red["']?/gi,""),n=n.replace(/fill\s*:\s*red/gi,""),n=n.replace(/background[^;]*red[^;]*/gi,"background: transparent"),n=n.replace(/background[^;]*#ff[^;]*/gi,"background: transparent"),n=n.replace(/<rect[^>]*width\s*=\s*["']?100%["']?[^>]*>/gi,""),n=n.replace(/<rect[^>]*height\s*=\s*["']?100%["']?[^>]*>/gi,""),n.includes('style="background: transparent')||(n=n.replace(/<svg([^>]*)>/,'<svg$1 style="background: transparent !important;">'))),t.svgData=n;const o=parseInt(U.getAttribute("width"))||S.width,r=parseInt(U.getAttribute("height"))||S.height,i=(new DOMParser).parseFromString(n,"image/svg+xml"),a=i.documentElement,s=i.createElementNS("http://www.w3.org/2000/svg","rect");s.setAttribute("width","100%"),s.setAttribute("height","100%"),s.setAttribute("fill","#FFFFFF"),s.setAttribute("x","0"),s.setAttribute("y","0"),a.firstChild?a.insertBefore(s,a.firstChild):a.appendChild(s);const l=(new XMLSerializer).serializeToString(a),c=new Blob([l],{type:"image/svg+xml;charset=utf-8"}),d=URL.createObjectURL(c),g=new Image;g.onload=function(){const e=document.createElement("canvas");e.width=o,e.height=r;const n=e.getContext("2d");n.fillStyle="#FFFFFF",n.fillRect(0,0,e.width,e.height),n.drawImage(g,0,0,o,r),e.toBlob(function(e){t.previewPngBlob=e,URL.revokeObjectURL(d),Ke(),window.currentBulkEditIndex=void 0,We.textContent=`‚úÖ Updated: ${t.name}`},"image/png")},g.onerror=function(){URL.revokeObjectURL(d),Ke(),window.currentBulkEditIndex=void 0,We.textContent=`‚úÖ Updated: ${t.name}`},g.src=d}else Ke(),window.currentBulkEditIndex=void 0,We.textContent=`‚úÖ Updated: ${t.name}`},"image/png")}()}).catch(e=>{console.error("Conversion error:",e),q.textContent="üîÑ Convert to SVG",q.disabled=!1,alert("Conversion failed: "+e.message)})}function Ce(e){return e/180*3.141592654}document.getElementById("none").addEventListener("click",function(e){T="none",Be("none",["polygon","spline"]),Re()},!1),document.getElementById("polygon").addEventListener("click",function(e){T="polygon",Be("polygon",["none","spline"]),Re()},!1),document.getElementById("spline").addEventListener("click",function(e){T="spline",Be("spline",["none","polygon"]),Re()},!1),document.getElementById("clustering-binary").addEventListener("click",function(e){O="binary",Be("clustering-binary",["clustering-color"]),Re()},!1),document.getElementById("clustering-color").addEventListener("click",function(e){O="color",Be("clustering-color",["clustering-binary"]),Re()},!1),document.getElementById("clustering-cutout").addEventListener("click",function(e){N="cutout",Be("clustering-cutout",["clustering-stacked"]),Re()},!1),document.getElementById("clustering-stacked").addEventListener("click",function(e){N="stacked",Be("clustering-stacked",["clustering-cutout"]),Re()},!1),document.getElementById("filterspeckle").addEventListener("change",function(e){Ee=parseInt(this.value),document.getElementById("filterspecklevalue").innerHTML=this.value,Re()}),document.getElementById("colorprecision").addEventListener("change",function(e){ke=parseInt(this.value),document.getElementById("colorprecisionvalue").innerHTML=this.value,Re()}),document.getElementById("layerdifference").addEventListener("change",function(e){Ie=parseInt(this.value),document.getElementById("layerdifferencevalue").innerHTML=this.value,Re()}),document.getElementById("corner").addEventListener("change",function(e){ye=parseInt(this.value),document.getElementById("cornervalue").innerHTML=this.value,Re()}),document.getElementById("length").addEventListener("change",function(e){ve=parseFloat(this.value),document.getElementById("lengthvalue").innerHTML=ve,Re()}),document.getElementById("splice").addEventListener("change",function(e){_e=parseInt(this.value),document.getElementById("splicevalue").innerHTML=this.value,Re()}),document.getElementById("pathprecision").addEventListener("change",function(e){Le=parseInt(this.value),document.getElementById("pathprecisionvalue").innerHTML=this.value,Re()});class xe{constructor(e){try{console.log("Initializing converter, mode:",O),this.converter="color"==O?E.new_with_string(e):_.new_with_string(e),console.log("Converter created, initializing..."),this.converter.init(),console.log("Converter initialized successfully"),this.stopped=!1}catch(e){throw console.error("Error creating converter:",e),e}U.style.background="transparent",U.setAttribute("style","background: transparent;"),S.style.display="binary"==O?"none":"",S.style.opacity=""}run(){const e=this;return console.log("ConverterRunner.run() called"),new Promise(t=>{setTimeout(function n(){if(e.stopped||!e.converter)return console.log("Conversion stopped or converter freed"),void t();if(e.stopped)console.log("Conversion stopped"),t();else{let o=!1;const r=performance.now();try{for(;!(o=e.converter.tick())&&performance.now()-r<25;);const i=e.converter.progress();if(M.value=i,document.getElementById("canvas-container").style.opacity=i>=50?"0.3":(50-i)/25,i>=M.max)return console.log("Conversion 100% complete"),P.style.display="none",M.value=0,W.style.opacity="1",W.style.pointerEvents="auto",V.style.opacity="1",V.style.pointerEvents="auto",q.disabled=!1,q.textContent="üîÑ Convert to SVG",void t();o||e.stopped||!e.converter?(o&&console.log("Conversion done (tick returned true)"),t()):setTimeout(n,1)}catch(n){console.error("Error during conversion tick:",n),e.stopped=!0,t()}}},1)})}stop(){if(!this.stopped){this.stopped=!0;try{this.converter&&(this.converter.free(),this.converter=null)}catch(e){console.warn("Error freeing converter:",e)}}}}let Se=[],Fe=[],Ue=!1;const De=document.getElementById("bulkInput"),Me=document.getElementById("bulk-select-btn"),Pe=document.getElementById("bulk-clear-btn"),Te=document.getElementById("bulk-process-btn"),Oe=document.getElementById("bulk-download-btn"),Ne=document.getElementById("bulk-processing-panel"),ze=document.getElementById("bulk-file-list"),je=document.getElementById("bulk-count"),He=document.getElementById("bulk-progress"),$e=document.getElementById("bulk-progress-bar"),qe=document.getElementById("bulk-progress-text"),We=document.getElementById("bulk-status"),Ve=document.getElementById("bulk-add-more-btn"),Ge=document.getElementById("bulk-refresh-btn"),Xe=document.getElementById("bulk-gallery-controls");function Ze(){je.textContent=Se.length,ze.innerHTML="",0!==Se.length?Se.forEach((e,t)=>{const n=document.createElement("div");n.style.cssText="padding: 8px; margin: 4px 0; background: white; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; font-size: 12px;",n.innerHTML=`\n            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e.name}</span>\n            <span style="color: #999; margin-left: 10px; font-size: 11px;">${(e.size/1024).toFixed(1)} KB</span>\n        `,ze.appendChild(n)}):ze.innerHTML='<div style="color: #999; text-align: center; padding: 20px;">No files selected</div>'}async function Je(e){try{const t=await new Promise((t,n)=>{const o=new FileReader;o.onload=()=>{const e=new Image;e.onload=()=>{const n=document.createElement("canvas"),o=n.getContext("2d"),r=1024;let i=e.width,a=e.height;if(i>r||a>r){const e=Math.min(r/i,r/a);i=Math.round(i*e),a=Math.round(a*e)}n.width=i,n.height=a,o.drawImage(e,0,0,i,a),n.toBlob(e=>{t(e)},"image/png")},e.onerror=()=>n(new Error("Failed to load image")),e.src=o.result},o.onerror=()=>n(new Error("Failed to read file")),o.readAsDataURL(e)}),n=await(0,A.hS)(t,{model:"isnet_fp16",output:{format:"image/png"}}),o=new Image;return new Promise((e,t)=>{o.onload=()=>{const t=document.createElement("canvas");t.width=o.width,t.height=o.height;const n=t.getContext("2d");n.drawImage(o,0,0);const r=n.getImageData(0,0,t.width,t.height).data,i=t.width,a=t.height,s=new Uint8ClampedArray(r);for(let e=2;e<a-2;e++)for(let t=2;t<i-2;t++){const n=4*(e*i+t),o=r[n+3];if(o>128){let a=o;for(let n=-2;n<=2;n++)for(let o=-2;o<=2;o++){if(0===o&&0===n)continue;const s=r[4*((e+n)*i+(t+o))+3];s>a&&(a=s)}a>o&&o>50&&(s[n+3]=Math.min(255,o+.3*(a-o)))}}for(let e=1;e<a-1;e++)for(let t=1;t<i-1;t++){const n=4*(e*i+t),o=s[n+3];if(o>20&&o<235){const r=s[4*((e-1)*i+t)+3],a=s[4*((e+1)*i+t)+3],l=s[4*(e*i+(t-1))+3],c=s[4*(e*i+(t+1))+3],d=Math.round((3*o+r+a+l+c)/7);s[n+3]=d}}for(let e=0;e<s.length;e+=4){const t=s[e+3];t>30&&t<200&&s[e]+s[e+1]+s[e+2]>50&&(s[e+3]=Math.min(255,1.15*t))}n.putImageData(new ImageData(s,i,a),0,0),t.toBlob(t=>{e(t)},"image/png")},o.onerror=()=>t(new Error("Failed to load processed image")),o.src=URL.createObjectURL(n)})}catch(e){throw new Error("Failed to process image: "+e.message)}}async function Ye(e){return new Promise((t,n)=>{const o=new Image;o.onload=function(){try{const e=S.width,r=S.height;Array.from(U.children),U.getAttribute("viewBox"),U.getAttribute("width"),U.getAttribute("height"),U.getAttribute("style"),S.width=o.width,S.height=o.height,F.clearRect(0,0,S.width,S.height),F.drawImage(o,0,0);const i=F.getImageData(0,0,S.width,S.height),a=i.data;for(let e=0;e<a.length;e+=4)a[e+3]<10&&(a[e+3]=0);for(F.putImageData(i,0,0);U.firstChild;)U.removeChild(U.firstChild);U.setAttribute("viewBox","0 0 "+o.width+" "+o.height),U.setAttribute("width",o.width),U.setAttribute("height",o.height),U.removeAttribute("fill"),U.removeAttribute("background"),U.setAttribute("style","background: transparent !important;"),U.style.background="transparent",U.style.backgroundColor="transparent",U.style.fill="none";const s="color"===O?"stacked":N,l={filter_speckle:4,color_precision:1,layer_difference:12,corner_threshold:Ce(60),length_threshold:4,splice_threshold:Ce(45)},c=JSON.stringify({canvas_id:S.id,svg_id:U.id,mode:"none",clustering_mode:O,hierarchical:s,corner_threshold:l.corner_threshold,length_threshold:l.length_threshold,max_iterations:10,splice_threshold:l.splice_threshold,filter_speckle:l.filter_speckle,color_precision:l.color_precision,layer_difference:l.layer_difference,path_precision:Le});let d;try{d="color"==O?E.new_with_string(c):_.new_with_string(c),d.init()}catch(t){return S.width=e,S.height=r,void n(new Error("Failed to create converter: "+t.message))}let g=0;const u=1e5,m=()=>{try{g++>u&&console.warn("Bulk conversion reached max ticks");let i=!1;const a=performance.now();for(;!(i=d.tick())&&performance.now()-a<25;);const s=d.progress();if(i||s>=100)return void setTimeout(()=>{U.querySelectorAll("rect").forEach(e=>{const t=e.getAttribute("width"),n=e.getAttribute("height"),o=e.getAttribute("x")||"0",r=e.getAttribute("y")||"0",i=e.getAttribute("fill")||"",a=(e.getAttribute("style"),U.getAttribute("width")),s=U.getAttribute("height"),l="100%"===t||t===a||parseFloat(t)>=.9*parseFloat(a||0),c="100%"===n||n===s||parseFloat(n)>=.9*parseFloat(s||0),d=!("0"!==o&&o||"0"!==r&&r),g=i.toLowerCase(),u=g.includes("red")||"#ff0000"===g||"#ff00"===g||g.startsWith("#ff")&&g.length<=7||g.includes("rgb(255")||g.includes("rgb(255,0");(l&&c&&d||u)&&e.remove()});const i=U.getAttribute("fill")||"",a=U.getAttribute("style")||"";(i.toLowerCase().includes("red")||i.toLowerCase().includes("#ff"))&&U.removeAttribute("fill"),(a.toLowerCase().includes("red")||a.toLowerCase().includes("#ff"))&&U.removeAttribute("style"),U.removeAttribute("fill"),U.removeAttribute("background"),U.style.background="transparent",U.style.backgroundColor="transparent",U.setAttribute("style","background: transparent !important;"),U.querySelectorAll("*").forEach(e=>{const t=e.getAttribute("fill")||"",n=e.getAttribute("style")||"",o=t.toLowerCase(),r=n.toLowerCase();if((o.includes("red")||"#ff0000"===o||o.startsWith("#ff")&&o.length<=7||r.includes("fill:")&&(r.includes("red")||r.includes("#ff")))&&"rect"===e.tagName){const t=e.getAttribute("width")||"",n=e.getAttribute("height")||"";"100%"!==t&&"100%"!==n||e.remove()}});let s=(new XMLSerializer).serializeToString(U);try{const e=(new DOMParser).parseFromString(s,"image/svg+xml").documentElement;e.querySelectorAll("rect").forEach(t=>{const n=t.getAttribute("width")||"",o=t.getAttribute("height")||"",r=t.getAttribute("x")||"0",i=t.getAttribute("y")||"0",a=t.getAttribute("fill")||"",s=t.getAttribute("style")||"",l=e.getAttribute("width")||"",c=e.getAttribute("height")||"",d="100%"===n||n===l||parseFloat(n)>=.9*parseFloat(l||0),g="100%"===o||o===c||parseFloat(o)>=.9*parseFloat(c||0),u=!("0"!==r&&r||"0"!==i&&i),m=a.toLowerCase(),f=s.toLowerCase(),p=m.includes("red")||"#ff0000"===m||m.startsWith("#ff")&&m.length<=7||m.includes("rgb(255")||f.includes("fill:")&&(f.includes("red")||f.includes("#ff"));(d&&g&&u||p)&&t.remove()}),e.removeAttribute("fill"),e.removeAttribute("background"),e.removeAttribute("background-color"),e.setAttribute("style","background: transparent !important;"),e.querySelectorAll("*").forEach(e=>{const t=e.getAttribute("fill")||"",n=e.getAttribute("style")||"",o=t.toLowerCase(),r=n.toLowerCase();if(o.includes("red")||"#ff0000"===o||o.startsWith("#ff")&&o.length<=7||r.includes("fill:")&&(r.includes("red")||r.includes("#ff")))if("rect"===e.tagName)e.remove();else if(e.removeAttribute("fill"),n){const t=n.replace(/fill\s*:\s*[^;]+/gi,"").replace(/background[^;]*/gi,"").trim();t?e.setAttribute("style",t):e.removeAttribute("style")}}),s=(new XMLSerializer).serializeToString(e)}catch(e){console.warn("Error in final SVG cleanup:",e),s=s.replace(/fill\s*=\s*["']?#?ff[0-9a-fA-F]*["']?/gi,""),s=s.replace(/fill\s*:\s*#?ff[0-9a-fA-F]*/gi,""),s=s.replace(/fill\s*=\s*["']?red["']?/gi,"")}(s.includes('fill="#ff')||s.includes('fill="#FF')||s.includes('fill="red')||s.includes('fill="Red')||s.includes("fill:#ff")||s.includes("fill:red")||s.includes("background")&&(s.includes("red")||s.includes("#ff")))&&(s=s.replace(/fill\s*=\s*["']?#?ff[0-9a-fA-F]{0,6}["']?/gi,""),s=s.replace(/fill\s*:\s*#?ff[0-9a-fA-F]{0,6}/gi,""),s=s.replace(/fill\s*=\s*["']?red["']?/gi,""),s=s.replace(/fill\s*:\s*red/gi,""),s=s.replace(/background[^;]*red[^;]*/gi,"background: transparent"),s=s.replace(/background[^;]*#ff[^;]*/gi,"background: transparent"),s=s.replace(/<rect[^>]*width\s*=\s*["']?100%["']?[^>]*>/gi,""),s=s.replace(/<rect[^>]*height\s*=\s*["']?100%["']?[^>]*>/gi,""),s.includes('style="background: transparent')||(s=s.replace(/<svg([^>]*)>/,'<svg$1 style="background: transparent !important;">')));const l=U.children?U.children.length:0;if(console.log("Bulk conversion finished:",{svgLength:s?s.length:0,childrenCount:l}),!s||s.length<100||0===l)return d.free(),S.width=e,S.height=r,void n(new Error("SVG conversion produced empty result"));const c=(new DOMParser).parseFromString(s,"image/svg+xml"),g=c.documentElement,u=c.createElementNS("http://www.w3.org/2000/svg","rect");u.setAttribute("width","100%"),u.setAttribute("height","100%"),u.setAttribute("fill","#FFFFFF"),u.setAttribute("x","0"),u.setAttribute("y","0"),g.firstChild?g.insertBefore(u,g.firstChild):g.appendChild(u);const m=(new XMLSerializer).serializeToString(g),f=parseInt(U.getAttribute("width"))||o.width,p=parseInt(U.getAttribute("height"))||o.height,h=document.createElement("canvas");h.width=f,h.height=p;const b=h.getContext("2d",{willReadFrequently:!0}),w=new Blob([m],{type:"image/svg+xml;charset=utf-8"}),y=URL.createObjectURL(w),v=new Image;v.onload=function(){const n=document.createElement("canvas");n.width=f,n.height=p;const o=n.getContext("2d",{willReadFrequently:!0});o.clearRect(0,0,n.width,n.height),o.drawImage(v,0,0,f,p),b.fillStyle="#FFFFFF",b.fillRect(0,0,h.width,h.height);const i=o.getImageData(0,0,n.width,n.height),a=i.data;for(let e=0;e<a.length;e+=4){const t=a[e],n=a[e+1],o=a[e+2];a[e+3]>0&&t>180&&n<80&&o<80&&(a[e]=255,a[e+1]=255,a[e+2]=255)}o.putImageData(i,0,0),b.drawImage(n,0,0,f,p);const l=new Blob([s],{type:"image/svg+xml;charset=utf-8"}),c=URL.createObjectURL(l),g=new Image;g.onload=function(){const n=document.createElement("canvas");n.width=f,n.height=p;const o=n.getContext("2d",{willReadFrequently:!0});o.clearRect(0,0,n.width,n.height),o.drawImage(g,0,0,f,p),n.toBlob(function(n){h.toBlob(function(o){d.free(),URL.revokeObjectURL(y),URL.revokeObjectURL(c),S.width=e,S.height=r,t({svgData:s,pngBlob:n,previewPngBlob:o})},"image/png")},"image/png")},g.onerror=function(){h.toBlob(function(n){d.free(),URL.revokeObjectURL(y),URL.revokeObjectURL(c),S.width=e,S.height=r,t({svgData:s,pngBlob:n,previewPngBlob:n})},"image/png")},g.src=c},v.onerror=function(){d.free(),URL.revokeObjectURL(y),S.width=e,S.height=r,n(new Error("Failed to convert SVG to PNG"))},v.src=y},200);setTimeout(m,1)}catch(t){console.error("Bulk conversion error:",t),d.free(),S.width=e,S.height=r,n(new Error("Conversion error: "+t.message))}};setTimeout(m,1)}catch(e){n(new Error("Failed to setup vectorization: "+e.message))}},o.onerror=()=>n(new Error("Failed to load processed image")),o.src=URL.createObjectURL(e)})}function Ke(){const e=document.getElementById("bulk-results-gallery");e&&(e.innerHTML="",e.classList.add("active"),0!==Fe.length?Fe.forEach((t,n)=>{const o=document.createElement("div");o.className="bulk-result-item",o.dataset.index=n;const r=URL.createObjectURL(t.noBgImage);let i="";if(t.previewPngBlob)i=URL.createObjectURL(t.previewPngBlob);else if(t.svgData)try{const e=(new DOMParser).parseFromString(t.svgData,"image/svg+xml"),n=e.documentElement;n.querySelectorAll("rect").forEach(e=>{const t=e.getAttribute("width"),o=e.getAttribute("height");"100%"!==t&&t!==n.getAttribute("width")||"100%"!==o&&o!==n.getAttribute("height")||e.remove()});const o=e.createElementNS("http://www.w3.org/2000/svg","rect");o.setAttribute("width","100%"),o.setAttribute("height","100%"),o.setAttribute("fill","#FFFFFF"),o.setAttribute("x","0"),o.setAttribute("y","0"),n.firstChild?n.insertBefore(o,n.firstChild):n.appendChild(o);const r=(new XMLSerializer).serializeToString(n);i="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(r)))}catch(e){console.error("Error creating SVG preview:",e),i=t.svgPng?URL.createObjectURL(t.svgPng):""}else t.svgPng&&(i=URL.createObjectURL(t.svgPng));o.innerHTML='<div class="bulk-result-header"><div class="bulk-result-name" title="'+t.originalName+'">'+t.name+'</div><div class="bulk-result-actions"><button class="bulk-action-btn edit" data-index="'+n+'" data-action="edit">Edit</button><button class="bulk-action-btn download" data-index="'+n+'" data-action="download">Download</button></div></div><div class="bulk-result-previews"><div class="bulk-preview-card"><h4>No Background</h4><img src="'+r+'" alt="No background" class="bulk-preview-image" loading="lazy"></div><div class="bulk-preview-card"><h4>Vectorized</h4>'+(i?'<img src="'+i+'" alt="Vectorized" class="bulk-preview-svg" loading="lazy">':'<div style="padding: 20px; text-align: center; color: #999;">No vectorized image</div>')+"</div></div>",e.appendChild(o);const a=o.querySelector('[data-action="edit"]'),s=o.querySelector('[data-action="download"]');a.addEventListener("click",()=>function(e){const t=Fe[e];if(!t)return;const n=t.originalFile?URL.createObjectURL(t.originalFile):URL.createObjectURL(t.noBgImage),o=!!t.originalFile;window.skipBgReset=!0,o?(j=!1,window.bgRemoved=!1):(j=!0,window.bgRemoved=!0);const r=new Image;r.onload=function(){for(S.width=r.width,S.height=r.height,F.clearRect(0,0,S.width,S.height),F.drawImage(r,0,0);U.firstChild;)U.removeChild(U.firstChild);U.querySelectorAll('rect[width="100%"][height="100%"]').forEach(e=>e.remove()),ne=F.getImageData(0,0,S.width,S.height),D.src=n,U.setAttribute("viewBox",`0 0 ${S.width} ${S.height}`),U.setAttribute("width",S.width),U.setAttribute("height",S.height),U.removeAttribute("style"),U.setAttribute("style","background: transparent !important;"),U.style.background="transparent",U.style.backgroundColor="transparent",U.removeAttribute("fill"),U.removeAttribute("background-color"),$.style.display="none",H.style.display="grid",H.classList.add("active"),te=!0,q.disabled=!1,ae.disabled=!1,o?(ae.textContent="üé® Remove Background",ae.style.background=""):(ae.textContent="‚úÖ Background Removed",ae.style.background="#28a745 !important"),G&&(G.style.opacity="1",G.style.pointerEvents="auto"),X&&(X.disabled=!1,X.removeAttribute("disabled"),X.style.opacity="1",X.style.pointerEvents="auto",X.style.cursor="pointer"),window.currentBulkEditIndex=e,setTimeout(()=>{window.skipBgReset=!1},1e3),window.scrollTo({top:0,behavior:"smooth"}),We.textContent=`‚úèÔ∏è Editing: ${t.name}. Make your changes and click "Convert to SVG" to update.`},r.onerror=()=>{alert("Failed to load image for editing."),window.skipBgReset=!1},r.src=n}(n)),s.addEventListener("click",()=>function(e){const t=Fe[e];if(!t)return;const n=new(C());n.file("no-background/"+t.name+".png",t.noBgImage),t.svgData&&n.file("vectorized/"+t.name+".svg",t.svgData),t.svgPng&&n.file("vectorized/"+t.name+".png",t.svgPng),n.generateAsync({type:"blob"}).then(function(e){const n=URL.createObjectURL(e),o=document.createElement("a");o.href=n,o.download=t.name+"-haidar-app.zip",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)})}(n))}):e.innerHTML='<div style="text-align: center; padding: 20px; color: #999;">No results to display</div>')}Ve&&Ge&&Xe||console.warn("Some bulk gallery control elements not found:",{bulkAddMoreBtn:!!Ve,bulkRefreshBtn:!!Ge,bulkGalleryControls:!!Xe}),Me.addEventListener("click",function(){De.click()}),De.addEventListener("change",function(e){const t=Array.from(e.target.files);0!==t.length&&(Fe.length>0&&Se.length>0?(Se=[...Se,...t],We.textContent=`‚ûï Added ${t.length} more image(s). Total: ${Se.length}`,setTimeout(()=>{We&&(We.textContent="")},3e3)):(Se=t,Fe=[]),Ze(),Ne.style.display="block",Te.disabled=!1,Oe.style.display="none",Xe&&(Xe.style.display="none"),De.value="")}),Pe.addEventListener("click",function(){Se=[],Fe=[],De.value="",Ze(),Ne.style.display="none",He.style.display="none",Oe.style.display="none",Xe&&(Xe.style.display="none");const e=document.getElementById("bulk-results-gallery");e&&(e.classList.remove("active"),e.innerHTML="")}),Ve&&Ve.addEventListener("click",function(){De.click()}),Ge&&Ge.addEventListener("click",function(){Fe.length>0&&(Ke(),We.textContent="‚úÖ Gallery refreshed",setTimeout(()=>{We&&(We.textContent="")},2e3))}),Te.addEventListener("click",async function(){if(0!==Se.length)if(z){Ue=!0,Te.disabled=!0,Te.textContent="‚è≥ Processing...",He.style.display="block",$e.style.width="0%",qe.textContent="0 / "+Se.length,We.textContent="Starting bulk processing...",Fe=[];try{for(let e=0;e<Se.length;e++){const t=Se[e];We.textContent=`Processing ${e+1}/${Se.length}: ${t.name}`;try{We.textContent=`Removing background: ${t.name}...`;const n=await Je(t);We.textContent=`Vectorizing: ${t.name}...`;const o=await Ye(n),r=t.name.replace(/\.[^/.]+$/,"");Fe.push({originalName:t.name,name:r,originalFile:t,noBgImage:n,svgData:o.svgData,svgPng:o.pngBlob,previewPngBlob:o.previewPngBlob});const i=(e+1)/Se.length*100;$e.style.width=i+"%",qe.textContent=e+1+" / "+Se.length}catch(e){console.error(`Error processing ${t.name}:`,e),We.textContent=`Error processing ${t.name}: ${e.message}`}}We.textContent=`‚úÖ Completed! Processed ${Fe.length} images.`,Te.disabled=!1,Te.textContent="üöÄ Process All Images",Oe.style.display="block",Xe&&(Xe.style.display="flex",Xe.style.flexDirection="row",Xe.style.gap="10px"),Ue=!1,Ke()}catch(e){console.error("Bulk processing error:",e),We.textContent=`‚ùå Error: ${e.message}`,Te.disabled=!1,Te.textContent="üöÄ Process All Images",Ue=!1}}else alert("WASM module is still initializing. Please wait a moment and try again.");else alert("Please select images first.")}),Oe.addEventListener("click",async function(){if(0!==Fe.length){Oe.disabled=!0,Oe.textContent="‚è≥ Creating ZIP...";try{const e=new(C()),t=e.folder("no-background"),n=e.folder("vectorized");for(const e of Fe)t.file(e.name+".png",e.noBgImage),e.svgData&&n.file(e.name+".svg",e.svgData),e.svgPng&&n.file(e.name+".png",e.svgPng);const o=await e.generateAsync({type:"blob"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download="haidar-app-bulk-results-"+(new Date).toISOString().slice(0,19).replace(/:/g,"").replace("T"," ")+".zip",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),Oe.disabled=!1,Oe.textContent="üíæ Download All Results (ZIP)",We.textContent=`‚úÖ Downloaded ZIP with ${Fe.length} images!`}catch(e){console.error("Error creating ZIP:",e),alert("Error creating ZIP file: "+e.message),Oe.disabled=!1,Oe.textContent="üíæ Download All Results (ZIP)"}}else alert("No results to download. Please process images first.")})}}]);